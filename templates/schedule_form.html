{% extends "base.html" %}

{% block title %}
{% if mode == 'create' %}
Add New Schedule - Audio Stream Recorder
{% else %}
Edit Schedule - Audio Stream Recorder
{% endif %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        {% if mode == 'create' %}
        Add New Recording Schedule
        {% else %}
        Edit Recording Schedule
        {% endif %}
    </h1>
    <a href="{{ url_for('main.schedules') }}" class="btn btn-secondary">Back to Schedules</a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Schedule Configuration</h5>
            </div>
            <div class="card-body">
                <form id="schedule-form">
                    <div class="form-group">
                        <label for="stream_config_id" class="form-label">Stream Configuration *</label>
                        <select id="stream_config_id" name="stream_config_id" class="form-control" required>
                            <option value="">Select a stream configuration...</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <div class="invalid-feedback"></div>
                        <small class="form-text text-muted">Choose which stream to record.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="schedule_time" class="form-label">Recording Time *</label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="time" id="schedule_time" name="schedule_time" class="form-control" required>
                                <small class="form-text text-muted">Time in 24-hour format (local time)</small>
                            </div>
                            <div class="col-md-6">
                                <select id="schedule_frequency" name="schedule_frequency" class="form-control" required>
                                    <option value="daily">Daily</option>
                                    <option value="weekdays">Weekdays (Mon-Fri)</option>
                                    <option value="weekends">Weekends (Sat-Sun)</option>
                                    <option value="monday">Mondays</option>
                                    <option value="tuesday">Tuesdays</option>
                                    <option value="wednesday">Wednesdays</option>
                                    <option value="thursday">Thursdays</option>
                                    <option value="friday">Fridays</option>
                                    <option value="saturday">Saturdays</option>
                                    <option value="sunday">Sundays</option>
                                </select>
                                <small class="form-text text-muted">How often to record</small>
                            </div>
                        </div>
                        <div class="invalid-feedback"></div>
                    </div>

                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="duration_hours" class="form-label">Duration (Hours)</label>
                                <input type="number" id="duration_hours" name="duration_hours" class="form-control" 
                                       min="0" max="23" value="1">
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="duration_minutes" class="form-label">Duration (Minutes)</label>
                                <input type="number" id="duration_minutes" name="duration_minutes" class="form-control" 
                                       min="0" max="59" value="0">
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="max_retries" class="form-label">Maximum Retries</label>
                        <input type="number" id="max_retries" name="max_retries" class="form-control" 
                               min="0" max="10" value="3">
                        <div class="invalid-feedback"></div>
                        <small class="form-text text-muted">
                            Number of times to retry if recording fails.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" id="is_active" name="is_active" class="form-check-input" checked>
                            <label for="is_active" class="form-check-label">
                                Activate schedule immediately
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            Uncheck to create the schedule in inactive state.
                        </small>
                    </div>
                    
                    <div class="form-group mt-4">
                        <button type="submit" id="submit-btn" class="btn btn-primary">
                            {% if mode == 'create' %}
                            Create Recording Schedule
                            {% else %}
                            Update Recording Schedule
                            {% endif %}
                        </button>
                        <a href="{{ url_for('main.schedules') }}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Schedule Guide</h5>
            </div>
            <div class="card-body">
                <p class="small">Choose when to record your stream:</p>
                
                <h6 class="mt-3">Time Format:</h6>
                <p class="small">Use 24-hour format (e.g., 14:30 for 2:30 PM)</p>
                
                <h6 class="mt-3">Frequency Options:</h6>
                <ul class="small">
                    <li><strong>Daily:</strong> Every day at the specified time</li>
                    <li><strong>Weekdays:</strong> Monday through Friday</li>
                    <li><strong>Weekends:</strong> Saturday and Sunday</li>
                    <li><strong>Specific Days:</strong> Choose a particular day of the week</li>
                </ul>
                
                <h6 class="mt-3">Time Zone:</h6>
                <p class="small">All times are in your local time zone (Mountain Time)</p>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Recording Duration</h5>
            </div>
            <div class="card-body">
                <p class="small">Set how long each recording should last. The system will automatically stop recording after this duration.</p>
                
                <p class="small"><strong>Tips:</strong></p>
                <ul class="small">
                    <li>Consider the typical length of your shows</li>
                    <li>Add a few extra minutes as buffer</li>
                    <li>Maximum duration is 24 hours</li>
                </ul>
            </div>
        </div>
        
        {% if mode == 'edit' %}
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Schedule Status</h5>
            </div>
            <div class="card-body">
                <div id="schedule-status">
                    <!-- Status will be loaded here -->
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('schedule-form');
    const mode = '{{ mode }}';
    const scheduleId = {{ schedule_id if mode == 'edit' else 'null' }};
    
    // Load streams and existing data
    loadStreams();
    if (mode === 'edit' && scheduleId) {
        loadScheduleData(scheduleId);
    }
    
    // Event listeners
    form.addEventListener('submit', handleSubmit);
    
    function loadStreams() {
        fetch('/api/streams')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('stream_config_id');
                
                data.forEach(stream => {
                    const option = document.createElement('option');
                    option.value = stream.id;
                    option.textContent = `${stream.name} (${stream.artist} - ${stream.album})`;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading streams:', error);
                AudioRecorder.showAlert('Failed to load stream configurations', 'danger');
            });
    }
    
    function loadScheduleData(scheduleId) {
        fetch(`/api/schedules/${scheduleId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Schedule not found');
                }
                return response.json();
            })
            .then(data => {
                // Populate form fields
                document.getElementById('stream_config_id').value = data.stream_config_id;
                
                // Convert cron expression back to time and frequency
                const timeAndFreq = convertFromCron(data.cron_expression);
                document.getElementById('schedule_time').value = timeAndFreq.time;
                document.getElementById('schedule_frequency').value = timeAndFreq.frequency;
                
                // Convert minutes to hours and minutes
                const totalMinutes = data.duration_minutes;
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                
                document.getElementById('duration_hours').value = hours;
                document.getElementById('duration_minutes').value = minutes;
                document.getElementById('max_retries').value = data.max_retries;
                document.getElementById('is_active').checked = data.is_active;
                
                // Show schedule status
                showScheduleStatus(data);
            })
            .catch(error => {
                console.error('Error loading schedule data:', error);
                AudioRecorder.showAlert('Failed to load schedule data', 'danger');
                window.location.href = '/schedules';
            });
    }
    
    function showScheduleStatus(schedule) {
        const statusContainer = document.getElementById('schedule-status');
        if (!statusContainer) return;
        
        const nextRun = schedule.next_run_time ? new Date(schedule.next_run_time).toLocaleString() : 'Not scheduled';
        const lastRun = schedule.last_run_time ? new Date(schedule.last_run_time).toLocaleString() : 'Never';
        
        statusContainer.innerHTML = `
            <p><strong>Status:</strong> 
                <span class="badge ${schedule.is_active ? 'badge-success' : 'badge-secondary'}">
                    ${schedule.is_active ? 'Active' : 'Inactive'}
                </span>
            </p>
            <p><strong>Next Run:</strong> ${nextRun}</p>
            <p><strong>Last Run:</strong> ${lastRun}</p>
            <p><strong>Retry Count:</strong> ${schedule.retry_count}/${schedule.max_retries}</p>
        `;
    }
    
    function handleSubmit(event) {
        event.preventDefault();
        
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Saving...';
        
        // Clear previous validation errors
        clearValidationErrors();
        
        // Calculate total duration in minutes
        const hours = parseInt(document.getElementById('duration_hours').value) || 0;
        const minutes = parseInt(document.getElementById('duration_minutes').value) || 0;
        const totalMinutes = (hours * 60) + minutes;
        
        if (totalMinutes === 0) {
            AudioRecorder.showAlert('Duration must be at least 1 minute', 'danger');
            submitBtn.disabled = false;
            submitBtn.innerHTML = mode === 'create' ? 'Create Recording Schedule' : 'Update Recording Schedule';
            return;
        }
        
        // Convert time and frequency to cron expression
        const scheduleTime = document.getElementById('schedule_time').value;
        const frequency = document.getElementById('schedule_frequency').value;
        
        if (!scheduleTime) {
            AudioRecorder.showAlert('Please select a recording time', 'danger');
            submitBtn.disabled = false;
            submitBtn.innerHTML = mode === 'create' ? 'Create Recording Schedule' : 'Update Recording Schedule';
            return;
        }
        
        const cronExpression = convertToCron(scheduleTime, frequency);
        
        const formData = new FormData(form);
        const scheduleData = {
            stream_config_id: parseInt(formData.get('stream_config_id')),
            cron_expression: cronExpression,
            duration_minutes: totalMinutes,
            max_retries: parseInt(formData.get('max_retries')),
            is_active: formData.get('is_active') === 'on'
        };
        
        const url = mode === 'create' ? '/api/schedules' : `/api/schedules/${scheduleId}`;
        const method = mode === 'create' ? 'POST' : 'PUT';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(scheduleData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            AudioRecorder.showAlert(
                mode === 'create' ? 'Recording schedule created successfully' : 'Recording schedule updated successfully',
                'success'
            );
            window.location.href = '/schedules';
        })
        .catch(error => {
            console.error('Error saving schedule:', error);
            
            if (error.details) {
                // Handle validation errors
                showValidationErrors(error.details);
                AudioRecorder.showAlert('Please correct the validation errors', 'danger');
            } else {
                AudioRecorder.showAlert(error.message || 'Failed to save recording schedule', 'danger');
            }
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = mode === 'create' ? 'Create Recording Schedule' : 'Update Recording Schedule';
        });
    }
    

    
    function showValidationErrors(errors) {
        errors.forEach(error => {
            const field = document.getElementById(error.field);
            if (field) {
                field.classList.add('is-invalid');
                const feedback = field.parentElement.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.textContent = error.message;
                }
            }
        });
    }
    
    function clearValidationErrors() {
        const invalidFields = document.querySelectorAll('.is-invalid');
        invalidFields.forEach(field => {
            field.classList.remove('is-invalid');
        });
        
        const feedbacks = document.querySelectorAll('.invalid-feedback');
        feedbacks.forEach(feedback => {
            feedback.textContent = '';
        });
    }
    
    function convertToCron(timeString, frequency) {
        // Parse time (HH:MM format)
        const [hours, minutes] = timeString.split(':').map(num => parseInt(num));
        
        // Convert frequency to cron day-of-week
        let dayOfWeek;
        switch (frequency) {
            case 'daily': dayOfWeek = '*'; break;
            case 'weekdays': dayOfWeek = '1-5'; break;
            case 'weekends': dayOfWeek = '0,6'; break;
            case 'monday': dayOfWeek = '1'; break;
            case 'tuesday': dayOfWeek = '2'; break;
            case 'wednesday': dayOfWeek = '3'; break;
            case 'thursday': dayOfWeek = '4'; break;
            case 'friday': dayOfWeek = '5'; break;
            case 'saturday': dayOfWeek = '6'; break;
            case 'sunday': dayOfWeek = '0'; break;
            default: dayOfWeek = '*';
        }
        
        // Return cron expression: minute hour day month weekday
        return `${minutes} ${hours} * * ${dayOfWeek}`;
    }
    
    function convertFromCron(cronExpression) {
        // Parse cron expression: minute hour day month weekday
        const parts = cronExpression.split(' ');
        if (parts.length !== 5) {
            return { time: '09:00', frequency: 'daily' };
        }
        
        const [minute, hour, , , dayOfWeek] = parts;
        
        // Format time as HH:MM
        const timeString = `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
        
        // Convert day-of-week to frequency
        let frequency;
        switch (dayOfWeek) {
            case '*': frequency = 'daily'; break;
            case '1-5': frequency = 'weekdays'; break;
            case '0,6': frequency = 'weekends'; break;
            case '1': frequency = 'monday'; break;
            case '2': frequency = 'tuesday'; break;
            case '3': frequency = 'wednesday'; break;
            case '4': frequency = 'thursday'; break;
            case '5': frequency = 'friday'; break;
            case '6': frequency = 'saturday'; break;
            case '0': frequency = 'sunday'; break;
            default: frequency = 'daily';
        }
        
        return { time: timeString, frequency: frequency };
    }
});
</script>
{% endblock %}