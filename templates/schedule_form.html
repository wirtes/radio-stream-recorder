{% extends "base.html" %}

{% block title %}
{% if mode == 'create' %}
Add New Schedule - Audio Stream Recorder
{% else %}
Edit Schedule - Audio Stream Recorder
{% endif %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        {% if mode == 'create' %}
        Add New Recording Schedule
        {% else %}
        Edit Recording Schedule
        {% endif %}
    </h1>
    <a href="{{ url_for('main.schedules') }}" class="btn btn-secondary">Back to Schedules</a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Schedule Configuration</h5>
            </div>
            <div class="card-body">
                <form id="schedule-form">
                    <div class="form-group">
                        <label for="stream_config_id" class="form-label">Stream Configuration *</label>
                        <select id="stream_config_id" name="stream_config_id" class="form-control" required>
                            <option value="">Select a stream configuration...</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <div class="invalid-feedback"></div>
                        <small class="form-text text-muted">Choose which stream to record.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="cron_expression" class="form-label">Schedule (Cron Expression) *</label>
                        <div class="input-group">
                            <input type="text" id="cron_expression" name="cron_expression" class="form-control" 
                                   placeholder="0 9 * * 1-5" required>
                            <button type="button" id="cron-helper-btn" class="btn btn-outline-primary">Help</button>
                            <button type="button" id="validate-cron-btn" class="btn btn-outline-secondary">Validate</button>
                        </div>
                        <div class="invalid-feedback"></div>
                        <small class="form-text text-muted">
                            Format: minute hour day month weekday (e.g., "0 9 * * 1-5" for weekdays at 9 AM)
                        </small>
                    </div>
                    
                    <div id="cron-validation-result" class="mt-2" style="display: none;"></div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="duration_hours" class="form-label">Duration (Hours)</label>
                                <input type="number" id="duration_hours" name="duration_hours" class="form-control" 
                                       min="0" max="23" value="1">
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="duration_minutes" class="form-label">Duration (Minutes)</label>
                                <input type="number" id="duration_minutes" name="duration_minutes" class="form-control" 
                                       min="0" max="59" value="0">
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="max_retries" class="form-label">Maximum Retries</label>
                        <input type="number" id="max_retries" name="max_retries" class="form-control" 
                               min="0" max="10" value="3">
                        <div class="invalid-feedback"></div>
                        <small class="form-text text-muted">
                            Number of times to retry if recording fails.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" id="is_active" name="is_active" class="form-check-input" checked>
                            <label for="is_active" class="form-check-label">
                                Activate schedule immediately
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            Uncheck to create the schedule in inactive state.
                        </small>
                    </div>
                    
                    <div class="form-group mt-4">
                        <button type="submit" id="submit-btn" class="btn btn-primary">
                            {% if mode == 'create' %}
                            Create Recording Schedule
                            {% else %}
                            Update Recording Schedule
                            {% endif %}
                        </button>
                        <a href="{{ url_for('main.schedules') }}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Cron Expression Guide</h5>
            </div>
            <div class="card-body">
                <p class="small">Cron expressions have 5 fields:</p>
                <code class="small">minute hour day month weekday</code>
                
                <h6 class="mt-3">Common Examples:</h6>
                <ul class="small">
                    <li><code>0 9 * * *</code><br>Daily at 9:00 AM</li>
                    <li><code>0 9 * * 1-5</code><br>Weekdays at 9:00 AM</li>
                    <li><code>0 20 * * 0</code><br>Sundays at 8:00 PM</li>
                    <li><code>30 14 * * 6</code><br>Saturdays at 2:30 PM</li>
                    <li><code>0 */2 * * *</code><br>Every 2 hours</li>
                    <li><code>0 0 1 * *</code><br>First day of each month</li>
                </ul>
                
                <h6 class="mt-3">Special Characters:</h6>
                <ul class="small">
                    <li><code>*</code> - Any value</li>
                    <li><code>,</code> - List separator</li>
                    <li><code>-</code> - Range</li>
                    <li><code>/</code> - Step values</li>
                </ul>
                
                <h6 class="mt-3">Weekdays:</h6>
                <p class="small">0=Sunday, 1=Monday, ..., 6=Saturday</p>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Recording Duration</h5>
            </div>
            <div class="card-body">
                <p class="small">Set how long each recording should last. The system will automatically stop recording after this duration.</p>
                
                <p class="small"><strong>Tips:</strong></p>
                <ul class="small">
                    <li>Consider the typical length of your shows</li>
                    <li>Add a few extra minutes as buffer</li>
                    <li>Maximum duration is 24 hours</li>
                </ul>
            </div>
        </div>
        
        {% if mode == 'edit' %}
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Schedule Status</h5>
            </div>
            <div class="card-body">
                <div id="schedule-status">
                    <!-- Status will be loaded here -->
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Cron Helper Modal -->
<div id="cron-helper-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h5>Cron Expression Builder</h5>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Quick Presets:</h6>
                    <div class="preset-buttons">
                        <button class="btn btn-sm btn-outline-primary mb-1" onclick="setCronPreset('0 9 * * 1-5')">Weekdays 9 AM</button>
                        <button class="btn btn-sm btn-outline-primary mb-1" onclick="setCronPreset('0 20 * * 0')">Sundays 8 PM</button>
                        <button class="btn btn-sm btn-outline-primary mb-1" onclick="setCronPreset('0 14 * * 6')">Saturdays 2 PM</button>
                        <button class="btn btn-sm btn-outline-primary mb-1" onclick="setCronPreset('0 */6 * * *')">Every 6 hours</button>
                        <button class="btn btn-sm btn-outline-primary mb-1" onclick="setCronPreset('0 0 * * *')">Daily midnight</button>
                        <button class="btn btn-sm btn-outline-primary mb-1" onclick="setCronPreset('0 12 * * *')">Daily noon</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="modal-cron-input" class="form-label">Cron Expression</label>
                        <input type="text" id="modal-cron-input" class="form-control" placeholder="0 9 * * 1-5">
                    </div>
                    
                    <button id="modal-validate-cron" class="btn btn-primary">Validate</button>
                    
                    <div id="modal-cron-result" class="mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="use-cron-expression" class="btn btn-primary">Use This Expression</button>
            <button id="modal-cron-close" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('schedule-form');
    const mode = '{{ mode }}';
    const scheduleId = {{ schedule_id if mode == 'edit' else 'null' }};
    
    // Load streams and existing data
    loadStreams();
    if (mode === 'edit' && scheduleId) {
        loadScheduleData(scheduleId);
    }
    
    // Event listeners
    form.addEventListener('submit', handleSubmit);
    document.getElementById('validate-cron-btn').addEventListener('click', validateCronExpression);
    document.getElementById('cron-helper-btn').addEventListener('click', showCronHelper);
    
    // Modal event listeners
    document.getElementById('modal-validate-cron').addEventListener('click', validateModalCron);
    document.getElementById('use-cron-expression').addEventListener('click', useCronExpression);
    document.getElementById('modal-cron-close').addEventListener('click', hideCronHelper);
    document.querySelector('.modal-close').addEventListener('click', hideCronHelper);
    
    function loadStreams() {
        fetch('/api/streams')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('stream_config_id');
                
                data.forEach(stream => {
                    const option = document.createElement('option');
                    option.value = stream.id;
                    option.textContent = `${stream.name} (${stream.artist} - ${stream.album})`;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading streams:', error);
                AudioRecorder.showAlert('Failed to load stream configurations', 'danger');
            });
    }
    
    function loadScheduleData(scheduleId) {
        fetch(`/api/schedules/${scheduleId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Schedule not found');
                }
                return response.json();
            })
            .then(data => {
                // Populate form fields
                document.getElementById('stream_config_id').value = data.stream_config_id;
                document.getElementById('cron_expression').value = data.cron_expression;
                
                // Convert minutes to hours and minutes
                const totalMinutes = data.duration_minutes;
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                
                document.getElementById('duration_hours').value = hours;
                document.getElementById('duration_minutes').value = minutes;
                document.getElementById('max_retries').value = data.max_retries;
                document.getElementById('is_active').checked = data.is_active;
                
                // Show schedule status
                showScheduleStatus(data);
            })
            .catch(error => {
                console.error('Error loading schedule data:', error);
                AudioRecorder.showAlert('Failed to load schedule data', 'danger');
                window.location.href = '/schedules';
            });
    }
    
    function showScheduleStatus(schedule) {
        const statusContainer = document.getElementById('schedule-status');
        if (!statusContainer) return;
        
        const nextRun = schedule.next_run_time ? new Date(schedule.next_run_time).toLocaleString() : 'Not scheduled';
        const lastRun = schedule.last_run_time ? new Date(schedule.last_run_time).toLocaleString() : 'Never';
        
        statusContainer.innerHTML = `
            <p><strong>Status:</strong> 
                <span class="badge ${schedule.is_active ? 'badge-success' : 'badge-secondary'}">
                    ${schedule.is_active ? 'Active' : 'Inactive'}
                </span>
            </p>
            <p><strong>Next Run:</strong> ${nextRun}</p>
            <p><strong>Last Run:</strong> ${lastRun}</p>
            <p><strong>Retry Count:</strong> ${schedule.retry_count}/${schedule.max_retries}</p>
        `;
    }
    
    function handleSubmit(event) {
        event.preventDefault();
        
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Saving...';
        
        // Clear previous validation errors
        clearValidationErrors();
        
        // Calculate total duration in minutes
        const hours = parseInt(document.getElementById('duration_hours').value) || 0;
        const minutes = parseInt(document.getElementById('duration_minutes').value) || 0;
        const totalMinutes = (hours * 60) + minutes;
        
        if (totalMinutes === 0) {
            AudioRecorder.showAlert('Duration must be at least 1 minute', 'danger');
            submitBtn.disabled = false;
            submitBtn.innerHTML = mode === 'create' ? 'Create Recording Schedule' : 'Update Recording Schedule';
            return;
        }
        
        const formData = new FormData(form);
        const scheduleData = {
            stream_config_id: parseInt(formData.get('stream_config_id')),
            cron_expression: formData.get('cron_expression'),
            duration_minutes: totalMinutes,
            max_retries: parseInt(formData.get('max_retries')),
            is_active: formData.get('is_active') === 'on'
        };
        
        const url = mode === 'create' ? '/api/schedules' : `/api/schedules/${scheduleId}`;
        const method = mode === 'create' ? 'POST' : 'PUT';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(scheduleData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            AudioRecorder.showAlert(
                mode === 'create' ? 'Recording schedule created successfully' : 'Recording schedule updated successfully',
                'success'
            );
            window.location.href = '/schedules';
        })
        .catch(error => {
            console.error('Error saving schedule:', error);
            
            if (error.details) {
                // Handle validation errors
                showValidationErrors(error.details);
                AudioRecorder.showAlert('Please correct the validation errors', 'danger');
            } else {
                AudioRecorder.showAlert(error.message || 'Failed to save recording schedule', 'danger');
            }
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = mode === 'create' ? 'Create Recording Schedule' : 'Update Recording Schedule';
        });
    }
    
    function validateCronExpression() {
        const cronInput = document.getElementById('cron_expression');
        const cronExpression = cronInput.value.trim();
        
        if (!cronExpression) {
            AudioRecorder.showAlert('Please enter a cron expression first', 'warning');
            return;
        }
        
        fetch('/api/schedules/validate-cron', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ cron_expression: cronExpression })
        })
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('cron-validation-result');
            
            if (data.valid) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Valid cron expression!</strong><br>
                        <strong>Description:</strong> ${data.description}<br>
                        <strong>Next run:</strong> ${new Date(data.next_run_time).toLocaleString()}
                    </div>
                `;
                cronInput.classList.remove('is-invalid');
                cronInput.classList.add('is-valid');
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Invalid cron expression:</strong> ${data.error}
                    </div>
                `;
                cronInput.classList.remove('is-valid');
                cronInput.classList.add('is-invalid');
            }
            
            resultDiv.style.display = 'block';
        })
        .catch(error => {
            console.error('Cron validation error:', error);
            AudioRecorder.showAlert('Failed to validate cron expression', 'danger');
        });
    }
    
    function showCronHelper() {
        const currentCron = document.getElementById('cron_expression').value;
        document.getElementById('modal-cron-input').value = currentCron;
        document.getElementById('modal-cron-result').style.display = 'none';
        document.getElementById('cron-helper-modal').style.display = 'block';
    }
    
    function hideCronHelper() {
        document.getElementById('cron-helper-modal').style.display = 'none';
    }
    
    function validateModalCron() {
        const cronInput = document.getElementById('modal-cron-input');
        const cronExpression = cronInput.value.trim();
        
        if (!cronExpression) {
            AudioRecorder.showAlert('Please enter a cron expression', 'warning');
            return;
        }
        
        fetch('/api/schedules/validate-cron', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ cron_expression: cronExpression })
        })
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('modal-cron-result');
            
            if (data.valid) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Description:</strong> ${data.description}<br>
                        <strong>Next 3 runs:</strong>
                        <ul class="mb-0">
                            ${data.next_runs.slice(0, 3).map(run => 
                                `<li>${new Date(run).toLocaleString()}</li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${data.error}
                    </div>
                `;
            }
            
            resultDiv.style.display = 'block';
        })
        .catch(error => {
            console.error('Cron validation error:', error);
            AudioRecorder.showAlert('Failed to validate cron expression', 'danger');
        });
    }
    
    function useCronExpression() {
        const modalCron = document.getElementById('modal-cron-input').value;
        document.getElementById('cron_expression').value = modalCron;
        hideCronHelper();
        
        // Validate the expression in the main form
        validateCronExpression();
    }
    
    window.setCronPreset = function(cronExpression) {
        document.getElementById('modal-cron-input').value = cronExpression;
        validateModalCron();
    };
    
    function showValidationErrors(errors) {
        errors.forEach(error => {
            const field = document.getElementById(error.field);
            if (field) {
                field.classList.add('is-invalid');
                const feedback = field.parentElement.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.textContent = error.message;
                }
            }
        });
    }
    
    function clearValidationErrors() {
        const invalidFields = document.querySelectorAll('.is-invalid');
        invalidFields.forEach(field => {
            field.classList.remove('is-invalid');
        });
        
        const feedbacks = document.querySelectorAll('.invalid-feedback');
        feedbacks.forEach(feedback => {
            feedback.textContent = '';
        });
    }
});
</script>
{% endblock %}